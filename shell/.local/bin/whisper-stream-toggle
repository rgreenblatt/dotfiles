#!/usr/bin/env python3
"""Toggle whisper streaming on/off."""

import subprocess
import os
import signal
import time

PID_FILE = "/tmp/whisper-stream.pid"


def is_streaming():
    """Check if streaming is currently active."""
    if not os.path.exists(PID_FILE):
        return False
    try:
        with open(PID_FILE) as f:
            pid = int(f.read().strip())
        os.kill(pid, 0)
        return True
    except (ProcessLookupError, ValueError, FileNotFoundError):
        return False


def stop_streaming():
    """Stop the streaming daemon."""
    if not os.path.exists(PID_FILE):
        return

    try:
        with open(PID_FILE) as f:
            pid = int(f.read().strip())
    except (ValueError, FileNotFoundError):
        return

    # Send SIGINT for graceful shutdown
    try:
        os.kill(pid, signal.SIGINT)
        # Wait for process to finish
        for _ in range(40):  # 2 seconds max
            try:
                os.kill(pid, 0)
                time.sleep(0.05)
            except ProcessLookupError:
                break
    except ProcessLookupError:
        pass

    # Clean up PID file if still exists
    if os.path.exists(PID_FILE):
        try:
            os.unlink(PID_FILE)
        except FileNotFoundError:
            pass


def start_streaming():
    """Start the streaming daemon."""
    # Start daemon in background
    subprocess.Popen(
        ["whisper-stream-daemon"],
        stdout=subprocess.DEVNULL,
        stderr=subprocess.DEVNULL,
        start_new_session=True,
    )

    # Notify user
    subprocess.run(
        ["notify-send", "-u", "low", "-t", "1000", "Whisper", "Streaming..."],
        check=False,
    )


def main():
    if is_streaming():
        stop_streaming()
        # Notification will be sent by daemon after cleanup completes
    else:
        start_streaming()


if __name__ == "__main__":
    main()
